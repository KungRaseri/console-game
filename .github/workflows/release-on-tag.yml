name: Create Release on Tag

on:
  push:
    tags:
      - 'v*'  # Only trigger on tag pushes starting with 'v'
    branches-ignore:
      - '**'  # Explicitly ignore all branch pushes

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'

jobs:
  create-release:
    name: Build and Release Package
    runs-on: windows-latest
    
    permissions:
      contents: write
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for changelog
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build and package
      id: package
      run: |
        Write-Output "Running build-game-package.ps1..."
        cd scripts
        .\build-game-package.ps1 -Configuration ${{ env.CONFIGURATION }}
        cd ..
        
        # Extract version from manifest
        $manifest = Get-Content "package/package-manifest.json" | ConvertFrom-Json
        $version = $manifest.Version
        $jsonCount = $manifest.Components.JsonData.FileCount
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "json-count=$jsonCount" >> $env:GITHUB_OUTPUT
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "JSON_COUNT=$jsonCount" >> $env:GITHUB_ENV
        Write-Output "Built version: $version"
      shell: pwsh
      
    - name: Create release archives
      run: |
        Write-Output "Creating release archives..."
        
        # Create full package ZIP (all DLLs + RealmForge + Data)
        Compress-Archive -Path "package/*" -DestinationPath "RealmEngine-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmEngine-${{ env.VERSION }}.zip"
        
        # Create RealmForge standalone ZIP (just the editor)
        Compress-Archive -Path "package/RealmForge/*" -DestinationPath "RealmForge-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmForge-${{ env.VERSION }}.zip"
        
        # Create Libraries-only ZIP (DLLs for Godot integration)
        Compress-Archive -Path "package/Libraries/*" -DestinationPath "RealmEngine-Libraries-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmEngine-Libraries-${{ env.VERSION }}.zip"
        
        # Copy manifest to root for release attachment
        Copy-Item "package/package-manifest.json" -Destination "package-manifest.json"
        
        Write-Output "Release archives created successfully!"
      shell: pwsh
      
    - name: Generate changelog
      id: changelog
      run: |
        # Get previous tag
        $currentTag = "${{ github.ref_name }}"
        $tags = git tag --sort=-version:refname
        $prevTag = $tags | Where-Object { $_ -ne $currentTag } | Select-Object -First 1
        
        if ($prevTag) {
          Write-Output "Generating changelog from $prevTag to $currentTag"
          $commits = git log "$prevTag..$currentTag" --pretty=format:"- %s (%h)" --no-merges
        } else {
          Write-Output "Generating changelog for all commits (first release)"
          $commits = git log --pretty=format:"- %s (%h)" --no-merges --max-count=20
        }
        
        $changelog = $commits -join "`n"
        if ([string]::IsNullOrWhiteSpace($changelog)) {
          $changelog = "- Initial release"
        }
        
        Write-Output "changelog<<EOF" >> $env:GITHUB_OUTPUT
        Write-Output $changelog >> $env:GITHUB_OUTPUT
        Write-Output "EOF" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Generate release notes
      run: |
        $manifest = Get-Content "package-manifest.json" | ConvertFrom-Json
        $version = "${{ env.VERSION }}"
        $jsonCount = "${{ env.JSON_COUNT }}"
        $commit = "${{ github.sha }}"
        $repoUrl = "${{ github.server_url }}/${{ github.repository }}"
        $repoOwner = "${{ github.repository_owner }}"
        
        $notes = @"
## RealmEngine $version

**Build Date**: $($manifest.PackageDate)  
**Commit**: [$commit]($repoUrl/commit/$commit)

### What's Included

- **Game Libraries** - Core engine DLLs with XML IntelliSense documentation
- **RealmForge** - WPF desktop editor for JSON game data (v4.0 standards)
- **Game Data** - $jsonCount JSON files (abilities, items, enemies, NPCs, quests, etc.)
- **NuGet Packages** - Available on GitHub Packages

### Downloads

| Package | Description | Size |
|---------|-------------|------|
| **RealmEngine-$version.zip** | üì¶ Complete package (libraries + data + RealmForge) | Full |
| **RealmEngine-Libraries-$version.zip** | üìö DLLs only (for Godot C# integration) | ~2-5 MB |
| **RealmForge-$version.zip** | üõ†Ô∏è JSON Editor standalone | ~50 MB |
| **package-manifest.json** | üìã Build metadata and file inventory | <1 KB |

### Installation

#### For Godot Integration

1. Download ``RealmEngine-Libraries-$version.zip``
2. Extract to your Godot project folder
3. Reference DLLs in your C# scripts:
   ````csharp
   using RealmEngine.Core;
   using RealmEngine.Shared.Models;
   ````
4. IntelliSense documentation is automatically available

#### For Content Editing

1. Download ``RealmForge-$version.zip``
2. Extract and run ``RealmForge.exe``
3. Edit JSON game data with visual validation
4. All changes comply with JSON v4.0 standards

#### Via NuGet (GitHub Packages)

````bash
dotnet add package RealmEngine.Core --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json
dotnet add package RealmEngine.Shared --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json
dotnet add package RealmEngine.Data --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json
````

### Requirements

- **.NET 9.0 Runtime** (for RealmForge)
- **Godot 4.x with C# support** (for game integration)
- **Windows 10+** (for RealmForge - WPF application)

### Package Contents

**Libraries** (in RealmEngine-Libraries-*.zip):
- ``RealmEngine.Core.dll`` + ``.xml`` - Game mechanics (generators, validators, combat)
- ``RealmEngine.Shared.dll`` + ``.xml`` - Shared models and services
- ``RealmEngine.Data.dll`` + ``.xml`` - JSON data loading and validation

**RealmForge** (in RealmForge-*.zip):
- ``RealmForge.exe`` - Visual JSON editor
- All dependencies and runtime files

**Data** (in full package):
- $jsonCount JSON files organized by domain
- v4.0 compliant with reference system support

### Changes in This Release

${{ steps.changelog.outputs.changelog }}

### Documentation

- [Game Design Document](https://github.com/${{ github.repository }}/blob/main/docs/GDD-Main.md)
- [JSON v4.0 Standards](https://github.com/${{ github.repository }}/blob/main/docs/standards/json/README.md)
- [Reference System Guide](https://github.com/${{ github.repository }}/blob/main/docs/standards/json/JSON_REFERENCE_STANDARDS.md)

### Support

Found an issue? [Report it here](https://github.com/${{ github.repository }}/issues)
"@
        
        $notes | Out-File -FilePath release-notes.md -Encoding utf8
        Write-Output "Release notes generated"
      shell: pwsh
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          RealmEngine-${{ env.VERSION }}.zip
          RealmEngine-Libraries-${{ env.VERSION }}.zip
          RealmForge-${{ env.VERSION }}.zip
          package-manifest.json
        body_path: release-notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
        tag_name: ${{ github.ref_name }}
        name: RealmEngine ${{ env.VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
