name: Create Release on Tag

on:
  push:
    tags:
      - 'v*'  # Only trigger on tag pushes starting with 'v'
    branches-ignore:
      - '**'  # Explicitly ignore all branch pushes

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'

jobs:
  create-release:
    name: Build and Release Package
    runs-on: windows-latest
    
    permissions:
      contents: write
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for changelog
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build and package
      id: package
      run: |
        Write-Output "Running build-game-package.ps1..."
        cd scripts
        .\build-game-package.ps1 -Configuration ${{ env.CONFIGURATION }}
        cd ..
        
        # Extract version from manifest
        $manifest = Get-Content "package/package-manifest.json" | ConvertFrom-Json
        $version = $manifest.Version
        $jsonCount = $manifest.Components.JsonData.FileCount
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "json-count=$jsonCount" >> $env:GITHUB_OUTPUT
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "JSON_COUNT=$jsonCount" >> $env:GITHUB_ENV
        Write-Output "Built version: $version"
      shell: pwsh
      
    - name: Create release archives
      run: |
        Write-Output "Creating release archives..."
        
        # Create full package ZIP (all DLLs + RealmForge + Data)
        Compress-Archive -Path "package/*" -DestinationPath "RealmEngine-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmEngine-${{ env.VERSION }}.zip"
        
        # Create RealmForge standalone ZIP (just the editor)
        Compress-Archive -Path "package/RealmForge/*" -DestinationPath "RealmForge-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmForge-${{ env.VERSION }}.zip"
        
        # Create Libraries-only ZIP (DLLs for Godot integration)
        Compress-Archive -Path "package/Libraries/*" -DestinationPath "RealmEngine-Libraries-${{ env.VERSION }}.zip" -Force
        Write-Output "[OK] Created RealmEngine-Libraries-${{ env.VERSION }}.zip"
        
        # Copy manifest to root for release attachment
        Copy-Item "package/package-manifest.json" -Destination "package-manifest.json"
        
        Write-Output "Release archives created successfully!"
      shell: pwsh
      
    - name: Generate changelog
      id: changelog
      run: |
        # Get previous tag
        $currentTag = "${{ github.ref_name }}"
        $tags = git tag --sort=-version:refname
        $prevTag = $tags | Where-Object { $_ -ne $currentTag } | Select-Object -First 1
        
        if ($prevTag) {
          Write-Output "Generating changelog from $prevTag to $currentTag"
          $commits = git log "$prevTag..$currentTag" --pretty=format:"- %s (%h)" --no-merges
        } else {
          Write-Output "Generating changelog for all commits (first release)"
          $commits = git log --pretty=format:"- %s (%h)" --no-merges --max-count=20
        }
        
        $changelog = $commits -join "`n"
        if ([string]::IsNullOrWhiteSpace($changelog)) {
          $changelog = "- Initial release"
        }
        
        Write-Output "changelog<<EOF" >> $env:GITHUB_OUTPUT
        Write-Output $changelog >> $env:GITHUB_OUTPUT
        Write-Output "EOF" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Generate release notes
      run: |
        $manifest = Get-Content "package-manifest.json" | ConvertFrom-Json
        $version = "${{ env.VERSION }}"
        $jsonCount = "${{ env.JSON_COUNT }}"
        $commit = "${{ github.sha }}"
        $repoUrl = "${{ github.server_url }}/${{ github.repository }}"
        $repoOwner = "${{ github.repository_owner }}"
        
        # Build release notes using string builder to avoid YAML escaping issues
        $sb = New-Object System.Text.StringBuilder
        [void]$sb.AppendLine("## RealmEngine $version")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("**Build Date**: $($manifest.PackageDate)")
        [void]$sb.AppendLine("**Commit**: [$commit]($repoUrl/commit/$commit)")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### What's Included")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("- **Game Libraries** - Core engine DLLs with XML IntelliSense documentation")
        [void]$sb.AppendLine("- **RealmForge** - WPF desktop editor for JSON game data (v4.0 standards)")
        [void]$sb.AppendLine("- **Game Data** - $jsonCount JSON files (abilities, items, enemies, NPCs, quests, etc.)")
        [void]$sb.AppendLine("- **NuGet Packages** - Available on GitHub Packages")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Downloads")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("| Package | Description | Size |")
        [void]$sb.AppendLine("|---------|-------------|------|")
        [void]$sb.AppendLine("| **RealmEngine-$version.zip** | üì¶ Complete package (libraries + data + RealmForge) | Full |")
        [void]$sb.AppendLine("| **RealmEngine-Libraries-$version.zip** | üìö DLLs only (for Godot C# integration) | ~2-5 MB |")
        [void]$sb.AppendLine("| **RealmForge-$version.zip** | üõ†Ô∏è JSON Editor standalone | ~50 MB |")
        [void]$sb.AppendLine("| **package-manifest.json** | üìã Build metadata and file inventory | <1 KB |")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Installation")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("#### For Godot Integration")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("1. Download ``RealmEngine-Libraries-$version.zip``")
        [void]$sb.AppendLine("2. Extract to your Godot project folder")
        [void]$sb.AppendLine("3. Reference DLLs in your C# scripts:")
        [void]$sb.AppendLine("   ````csharp")
        [void]$sb.AppendLine("   using RealmEngine.Core;")
        [void]$sb.AppendLine("   using RealmEngine.Shared.Models;")
        [void]$sb.AppendLine("   ````")
        [void]$sb.AppendLine("4. IntelliSense documentation is automatically available")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("#### For Content Editing")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("1. Download ``RealmForge-$version.zip``")
        [void]$sb.AppendLine("2. Extract and run ``RealmForge.exe``")
        [void]$sb.AppendLine("3. Edit JSON game data with visual validation")
        [void]$sb.AppendLine("4. All changes comply with JSON v4.0 standards")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("#### Via NuGet (GitHub Packages)")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("````bash")
        [void]$sb.AppendLine("dotnet add package RealmEngine.Core --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json")
        [void]$sb.AppendLine("dotnet add package RealmEngine.Shared --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json")
        [void]$sb.AppendLine("dotnet add package RealmEngine.Data --version $version --source https://nuget.pkg.github.com/$repoOwner/index.json")
        [void]$sb.AppendLine("````")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Requirements")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("- **.NET 9.0 Runtime** (for RealmForge)")
        [void]$sb.AppendLine("- **Godot 4.x with C# support** (for game integration)")
        [void]$sb.AppendLine("- **Windows 10+** (for RealmForge - WPF application)")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Package Contents")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("**Libraries** (in RealmEngine-Libraries-*.zip):")
        [void]$sb.AppendLine("- ``RealmEngine.Core.dll`` + ``.xml`` - Game mechanics (generators, validators, combat)")
        [void]$sb.AppendLine("- ``RealmEngine.Shared.dll`` + ``.xml`` - Shared models and services")
        [void]$sb.AppendLine("- ``RealmEngine.Data.dll`` + ``.xml`` - JSON data loading and validation")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("**RealmForge** (in RealmForge-*.zip):")
        [void]$sb.AppendLine("- ``RealmForge.exe`` - Visual JSON editor")
        [void]$sb.AppendLine("- All dependencies and runtime files")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("**Data** (in full package):")
        [void]$sb.AppendLine("- $jsonCount JSON files organized by domain")
        [void]$sb.AppendLine("- v4.0 compliant with reference system support")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Changes in This Release")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("${{ steps.changelog.outputs.changelog }}")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Documentation")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("- [Game Design Document]($repoUrl/blob/main/docs/GDD-Main.md)")
        [void]$sb.AppendLine("- [JSON v4.0 Standards]($repoUrl/blob/main/docs/standards/json/README.md)")
        [void]$sb.AppendLine("- [Reference System Guide]($repoUrl/blob/main/docs/standards/json/JSON_REFERENCE_STANDARDS.md)")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("### Support")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("Found an issue? [Report it here]($repoUrl/issues)")
        
        $sb.ToString() | Out-File -FilePath release-notes.md -Encoding utf8
        Write-Output "Release notes generated"
      shell: pwsh
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          RealmEngine-${{ env.VERSION }}.zip
          RealmEngine-Libraries-${{ env.VERSION }}.zip
          RealmForge-${{ env.VERSION }}.zip
          package-manifest.json
        body_path: release-notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
        tag_name: ${{ github.ref_name }}
        name: RealmEngine ${{ env.VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
