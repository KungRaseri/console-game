name: Build and Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'

jobs:
  test:
    name: Run Tests
    runs-on: windows-latest
    
    permissions:
      checks: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore
      
    - name: Run RealmEngine.Shared.Tests
      run: dotnet test RealmEngine.Shared.Tests/RealmEngine.Shared.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=shared-tests.trx"
      continue-on-error: false
      
    - name: Run RealmEngine.Core.Tests
      run: dotnet test RealmEngine.Core.Tests/RealmEngine.Core.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=core-tests.trx"
      continue-on-error: false
      
    - name: Run RealmEngine.Data.Tests
      run: dotnet test RealmEngine.Data.Tests/RealmEngine.Data.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=data-tests.trx"
      continue-on-error: false
      
    - name: Run RealmForge.Tests
      run: dotnet test RealmForge.Tests/RealmForge.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=realmforge-tests.trx"
      continue-on-error: true
      
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action/windows@v2
      if: always()
      with:
        files: |
          **/TestResults/**/*.trx

  build-package:
    name: Build Game Package
    needs: test
    runs-on: windows-latest
    
    outputs:
      archive-name: ${{ steps.package.outputs.archive-name }}
      version: ${{ steps.package.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for commit count
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build and package with script
      id: package
      run: |
        Write-Output "Running build-game-package.ps1..."
        cd scripts
        .\build-game-package.ps1 -Configuration ${{ env.CONFIGURATION }}
        cd ..
        
        # Extract version from manifest
        $manifest = Get-Content "package/package-manifest.json" | ConvertFrom-Json
        $version = $manifest.Version
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "Built version: $version"
      shell: pwsh
      
    - name: Verify package contents
      run: |
        Write-Output "Verifying package structure..."
        
        # Check core files
        if (-not (Test-Path "package/Libraries/RealmEngine.Core/RealmEngine.Core.dll")) {
          Write-Error "RealmEngine.Core.dll not found!"
          exit 1
        }
        if (-not (Test-Path "package/RealmForge/RealmForge.exe")) {
          Write-Error "RealmForge.exe not found!"
          exit 1
        }
        if (-not (Test-Path "package/Data/Json")) {
          Write-Error "JSON data not found!"
          exit 1
        }
        if (-not (Test-Path "package/package-manifest.json")) {
          Write-Error "Package manifest not found!"
          exit 1
        }
        
        # Count files
        $jsonCount = (Get-ChildItem -Path "package/Data/Json" -Recurse -File).Count
        $dllCount = (Get-ChildItem -Path "package/Libraries" -Filter "*.dll" -Recurse).Count
        
        Write-Output "✓ Package verified successfully!"
        Write-Output "  - JSON files: $jsonCount"
        Write-Output "  - DLL files: $dllCount"
        Write-Output "  - RealmForge: Present"
        Write-Output "  - Manifest: Present"
      shell: pwsh
      
    - name: Create package archive
      id: archive
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $archiveName = "RealmEngine-$version.zip"
        
        Write-Output "Creating archive: $archiveName"
        Compress-Archive -Path "package/*" -DestinationPath $archiveName -Force
        
        $archiveSize = (Get-Item $archiveName).Length / 1MB
        Write-Output "Archive size: $([math]::Round($archiveSize, 2)) MB"
        
        Write-Output "archive-name=$archiveName" >> $env:GITHUB_OUTPUT
        Write-Output "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-package
        path: ${{ env.ARCHIVE_NAME }}
        retention-days: 30
        
    - name: Upload package manifest
      uses: actions/upload-artifact@v4
      with:
        name: package-manifest
        path: package/package-manifest.json
        retention-days: 30
        
    - name: Create RealmForge standalone archive
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $realmForgeArchive = "RealmForge-$version.zip"
        
        Write-Output "Creating RealmForge archive: $realmForgeArchive"
        Compress-Archive -Path "package/RealmForge/*" -DestinationPath $realmForgeArchive -Force
        
        $archiveSize = (Get-Item $realmForgeArchive).Length / 1MB
        Write-Output "RealmForge archive size: $([math]::Round($archiveSize, 2)) MB"
        
        Write-Output "realmforge-archive=$realmForgeArchive" >> $env:GITHUB_OUTPUT
        Write-Output "REALMFORGE_ARCHIVE=$realmForgeArchive" >> $env:GITHUB_ENV
      shell: pwsh
      id: realmforge
      
    - name: Upload RealmForge artifact
      uses: actions/upload-artifact@v4
      with:
        name: realmforge
        path: ${{ env.REALMFORGE_ARCHIVE }}
        retention-days: 30

  publish-nuget:
    name: Publish NuGet Packages
    needs: test
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'
    
    permissions:
      packages: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Generate version
      id: version
      run: |
        $version = .\scripts\generate-version.ps1 -OutputFormat "string"
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Generated version: $version"
      shell: pwsh
      
    - name: Pack RealmEngine.Core
      run: dotnet pack RealmEngine.Core/RealmEngine.Core.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Pack RealmEngine.Shared
      run: dotnet pack RealmEngine.Shared/RealmEngine.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Pack RealmEngine.Data
      run: dotnet pack RealmEngine.Data/RealmEngine.Data.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Publish to GitHub Packages
      run: |
        dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        dotnet nuget push "**/*.nupkg" --source github --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
      shell: pwsh

  # Release job moved to release-on-tag.yml workflow to avoid double CI runs
  # When auto-tag creates a tag, it triggers release-on-tag.yml instead

  auto-tag:
    name: Auto-Tag Version
    needs: [test, build-package]
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Get version from build
      id: get_version
      run: |
        $version = "${{ needs.build-package.outputs.version }}"
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Version from build: $version"
        
        # Check if tag already exists
        $tagExists = git tag -l "v$version"
        if ($tagExists) {
          Write-Output "TAG_EXISTS=true" >> $env:GITHUB_ENV
          Write-Output "Tag v$version already exists, skipping creation"
        } else {
          Write-Output "TAG_EXISTS=false" >> $env:GITHUB_ENV
          Write-Output "Tag v$version does not exist, will create"
        }
      shell: pwsh
      
    - name: Create and push tag
      if: env.TAG_EXISTS == 'false'
      run: |
        $version = "${{ env.VERSION }}"
        $tagName = "v$version"
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create annotated tag
        git tag -a "$tagName" -m "Release version $version"
        
        # Push tag (using PAT if available to trigger release workflow)
        git push origin "$tagName"
        
        Write-Output "✓ Created and pushed tag: $tagName"
        Write-Output "Note: If PAT_TOKEN secret exists, this will trigger release workflow"
      shell: pwsh

  notify:
    name: Build Notification
    needs: [test, build-package, publish-nuget, auto-tag]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: ${{ needs.build-package.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.ref }}" == refs/heads/main ]]; then
          echo "- **Auto-Tag**: ${{ needs.auto-tag.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **NuGet Publish**: ${{ needs.publish-nuget.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Tag creation will trigger separate release workflow" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ref**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
