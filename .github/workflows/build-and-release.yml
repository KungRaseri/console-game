name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'  # Match any tag starting with 'v' (includes v0.1.379-29c1030)
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'

jobs:
  test:
    name: Run Tests
    runs-on: windows-latest
    
    permissions:
      checks: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore
      
    - name: Run RealmEngine.Shared.Tests
      run: dotnet test RealmEngine.Shared.Tests/RealmEngine.Shared.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=shared-tests.trx"
      continue-on-error: false
      
    - name: Run RealmEngine.Core.Tests
      run: dotnet test RealmEngine.Core.Tests/RealmEngine.Core.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=core-tests.trx"
      continue-on-error: false
      
    - name: Run RealmEngine.Data.Tests
      run: dotnet test RealmEngine.Data.Tests/RealmEngine.Data.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=data-tests.trx"
      continue-on-error: false
      
    - name: Run RealmForge.Tests
      run: dotnet test RealmForge.Tests/RealmForge.Tests.csproj --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=realmforge-tests.trx"
      continue-on-error: true
      
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action/windows@v2
      if: always()
      with:
        files: |
          **/TestResults/**/*.trx

  build-package:
    name: Build Game Package
    needs: test
    runs-on: windows-latest
    
    outputs:
      archive-name: ${{ steps.package.outputs.archive-name }}
      version: ${{ steps.package.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for commit count
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build and package with script
      id: package
      run: |
        Write-Output "Running build-game-package.ps1..."
        cd scripts
        .\build-game-package.ps1 -Configuration ${{ env.CONFIGURATION }}
        cd ..
        
        # Extract version from manifest
        $manifest = Get-Content "package/package-manifest.json" | ConvertFrom-Json
        $version = $manifest.Version
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "Built version: $version"
      shell: pwsh
      
    - name: Verify package contents
      run: |
        Write-Output "Verifying package structure..."
        
        # Check core files
        if (-not (Test-Path "package/Libraries/RealmEngine.Core/RealmEngine.Core.dll")) {
          Write-Error "RealmEngine.Core.dll not found!"
          exit 1
        }
        if (-not (Test-Path "package/RealmForge/RealmForge.exe")) {
          Write-Error "RealmForge.exe not found!"
          exit 1
        }
        if (-not (Test-Path "package/Data/Json")) {
          Write-Error "JSON data not found!"
          exit 1
        }
        if (-not (Test-Path "package/package-manifest.json")) {
          Write-Error "Package manifest not found!"
          exit 1
        }
        
        # Count files
        $jsonCount = (Get-ChildItem -Path "package/Data/Json" -Recurse -File).Count
        $dllCount = (Get-ChildItem -Path "package/Libraries" -Filter "*.dll" -Recurse).Count
        
        Write-Output "✓ Package verified successfully!"
        Write-Output "  - JSON files: $jsonCount"
        Write-Output "  - DLL files: $dllCount"
        Write-Output "  - RealmForge: Present"
        Write-Output "  - Manifest: Present"
      shell: pwsh
      
    - name: Create package archive
      id: archive
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $archiveName = "RealmEngine-$version.zip"
        
        Write-Output "Creating archive: $archiveName"
        Compress-Archive -Path "package/*" -DestinationPath $archiveName -Force
        
        $archiveSize = (Get-Item $archiveName).Length / 1MB
        Write-Output "Archive size: $([math]::Round($archiveSize, 2)) MB"
        
        Write-Output "archive-name=$archiveName" >> $env:GITHUB_OUTPUT
        Write-Output "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-package
        path: ${{ env.ARCHIVE_NAME }}
        retention-days: 30
        
    - name: Upload package manifest
      uses: actions/upload-artifact@v4
      with:
        name: package-manifest
        path: package/package-manifest.json
        retention-days: 30
        
    - name: Create RealmForge standalone archive
      run: |
        $version = "${{ steps.package.outputs.version }}"
        $realmForgeArchive = "RealmForge-$version.zip"
        
        Write-Output "Creating RealmForge archive: $realmForgeArchive"
        Compress-Archive -Path "package/RealmForge/*" -DestinationPath $realmForgeArchive -Force
        
        $archiveSize = (Get-Item $realmForgeArchive).Length / 1MB
        Write-Output "RealmForge archive size: $([math]::Round($archiveSize, 2)) MB"
        
        Write-Output "realmforge-archive=$realmForgeArchive" >> $env:GITHUB_OUTPUT
        Write-Output "REALMFORGE_ARCHIVE=$realmForgeArchive" >> $env:GITHUB_ENV
      shell: pwsh
      id: realmforge
      
    - name: Upload RealmForge artifact
      uses: actions/upload-artifact@v4
      with:
        name: realmforge
        path: ${{ env.REALMFORGE_ARCHIVE }}
        retention-days: 30

  publish-nuget:
    name: Publish NuGet Packages
    needs: test
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'
    
    permissions:
      packages: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Generate version
      id: version
      run: |
        $version = .\scripts\generate-version.ps1 -OutputFormat "string"
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Generated version: $version"
      shell: pwsh
      
    - name: Pack RealmEngine.Core
      run: dotnet pack RealmEngine.Core/RealmEngine.Core.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Pack RealmEngine.Shared
      run: dotnet pack RealmEngine.Shared/RealmEngine.Shared.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Pack RealmEngine.Data
      run: dotnet pack RealmEngine.Data/RealmEngine.Data.csproj --configuration ${{ env.CONFIGURATION }} --no-restore -p:PackageVersion=${{ env.VERSION }} -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:RepositoryCommit=${{ github.sha }}
      
    - name: Publish to GitHub Packages
      run: |
        dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        dotnet nuget push "**/*.nupkg" --source github --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
      shell: pwsh

  release:
    name: Create GitHub Release
    needs: [build-package, publish-nuget]
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Download package artifact
      uses: actions/download-artifact@v4
      with:
        name: game-package
        
    - name: Download package manifest
      uses: actions/download-artifact@v4
      with:
        name: package-manifest
        
    - name: Download RealmForge artifact
      uses: actions/download-artifact@v4
      with:
        name: realmforge
        
    - name: Extract version info
      id: version
      run: |
        $version = "${{ github.ref_name }}"
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        
        # Read manifest for build info
        if (Test-Path "package-manifest.json") {
          $manifest = Get-Content "package-manifest.json" | ConvertFrom-Json
          Write-Output "Build Date: $($manifest.PackageDate)"
          Write-Output "Configuration: $($manifest.Configuration)"
        }
      shell: pwsh
      
    - name: Get previous tag
      id: prev_tag
      run: |
        $currentTag = "${{ github.ref_name }}"
        $tags = git tag --sort=-version:refname
        $prevTag = $tags | Where-Object { $_ -ne $currentTag } | Select-Object -First 1
        
        if ($prevTag) {
          Write-Output "PREV_TAG=$prevTag" >> $env:GITHUB_ENV
          Write-Output "previous-tag=$prevTag" >> $env:GITHUB_OUTPUT
          Write-Output "Previous tag: $prevTag"
        } else {
          Write-Output "No previous tag found"
          Write-Output "PREV_TAG=" >> $env:GITHUB_ENV
          Write-Output "previous-tag=" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
      
    - name: Generate commit changelog
      id: changelog
      run: |
        $currentTag = "${{ github.ref_name }}"
        $prevTag = "${{ steps.prev_tag.outputs.previous-tag }}"
        
        if ($prevTag) {
          Write-Output "Generating changelog from $prevTag to $currentTag"
          $commits = git log "$prevTag..$currentTag" --pretty=format:"- %s (%h)" --no-merges
        } else {
          Write-Output "Generating changelog for all commits"
          $commits = git log --pretty=format:"- %s (%h)" --no-merges --max-count=20
        }
        
        $changelog = $commits -join "`n"
        
        Write-Output "changelog<<EOF" >> $env:GITHUB_OUTPUT
        Write-Output $changelog >> $env:GITHUB_OUTPUT
        Write-Output "EOF" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Generate release notes
      id: release_notes
      run: |
        $manifest = Get-Content "package-manifest.json" | ConvertFrom-Json
        $jsonCount = $manifest.Components.JsonData.FileCount
        
        $notes = @"
        ## RealmEngine ${{ env.VERSION }}
        
        **Build Date**: $($manifest.PackageDate)
        **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
        
        ### What's Included
        
        - **Game Libraries** - Core game engine DLLs for Godot integration (with XML IntelliSense)
        - **RealmForge** - WPF desktop editor for JSON game data
        - **Game Data** - $jsonCount JSON files (abilities, items, enemies, NPCs, quests, etc.)
        - **NuGet Packages** - Available on GitHub Packages for easy integration
        
        ### Downloads
        
        - **RealmEngine-${{ env.VERSION }}.zip** - Full game package (libraries + data + RealmForge)
        - **RealmForge-${{ env.VERSION }}.zip** - Standalone JSON editor
        - **package-manifest.json** - Build metadata and file inventory
        
        ### Installation
        
        #### For Godot Integration
        
        1. Extract \`RealmEngine-${{ env.VERSION }}.zip\`
        2. Copy \`Libraries/\` folder to your Godot project
        3. Copy \`Data/Json/\` folder to your Godot project
        4. Reference RealmEngine.Core.dll in your C# scripts
        5. IntelliSense documentation is automatically available via XML files
        
        #### For Content Editing
        
        1. Extract \`RealmForge-${{ env.VERSION }}.zip\`
        2. Run \`RealmForge.exe\`
        3. Edit JSON game data with visual editor
        4. Changes are validated against v4.0 standards
        
        #### Via NuGet (GitHub Packages)
        
        \`\`\`bash
        dotnet add package RealmEngine.Core --version ${{ env.VERSION }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
        dotnet add package RealmEngine.Shared --version ${{ env.VERSION }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
        dotnet add package RealmEngine.Data --version ${{ env.VERSION }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
        \`\`\`
        
        ### Requirements
        
        - .NET 9.0 Runtime (for RealmForge)
        - Godot 4.x with C# support (for game integration)
        
        ### Package Contents
        
        - **RealmEngine.Core.dll** - Core game mechanics (generators, validators, features)
        - **RealmEngine.Core.xml** - IntelliSense documentation
        - **RealmEngine.Shared.dll** - Shared models and services
        - **RealmEngine.Shared.xml** - IntelliSense documentation
        - **RealmEngine.Data.dll** - Data loading and validation
        - **RealmEngine.Data.xml** - IntelliSense documentation
        - **RealmForge.exe** - Visual JSON editor
        - **$jsonCount JSON files** - v4.0 compliant game data
        
        ### Changes in This Release
        
        ${{ steps.changelog.outputs.changelog }}
        
        ### Documentation
        
        - [Game Design Document](https://github.com/${{ github.repository }}/blob/main/docs/GDD-Main.md)
        - [JSON v4.0 Standards](https://github.com/${{ github.repository }}/blob/main/docs/standards/json/README.md)
        - [Architecture Guide](https://github.com/${{ github.repository }}/blob/main/docs/ARCHITECTURE_DECISIONS.md)
        "@
        
        $notes | Out-File -FilePath release-notes.md -Encoding utf8
      shell: pwsh
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          RealmEngine-${{ env.VERSION }}.zip
          RealmForge-${{ env.VERSION }}.zip
          package-manifest.json
        body_path: release-notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
        tag_name: ${{ github.ref_name }}
        name: RealmEngine ${{ env.VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-tag:
    name: Auto-Tag Version
    needs: [test, build-package]
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Get version from build
      id: get_version
      run: |
        $version = "${{ needs.build-package.outputs.version }}"
        Write-Output "VERSION=$version" >> $env:GITHUB_ENV
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Version from build: $version"
        
        # Check if tag already exists
        $tagExists = git tag -l "v$version"
        if ($tagExists) {
          Write-Output "TAG_EXISTS=true" >> $env:GITHUB_ENV
          Write-Output "Tag v$version already exists, skipping creation"
        } else {
          Write-Output "TAG_EXISTS=false" >> $env:GITHUB_ENV
          Write-Output "Tag v$version does not exist, will create"
        }
      shell: pwsh
      
    - name: Create and push tag
      if: env.TAG_EXISTS == 'false'
      run: |
        $version = "${{ env.VERSION }}"
        $tagName = "v$version"
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create annotated tag
        git tag -a "$tagName" -m "Release version $version"
        
        # Push tag (using PAT if available to trigger release workflow)
        git push origin "$tagName"
        
        Write-Output "✓ Created and pushed tag: $tagName"
        Write-Output "Note: If PAT_TOKEN secret exists, this will trigger release workflow"
      shell: pwsh

  notify:
    name: Build Notification
    needs: [test, build-package, publish-nuget, release, auto-tag]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: ${{ needs.build-package.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.ref }}" == refs/heads/main ]]; then
          echo "- **Auto-Tag**: ${{ needs.auto-tag.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "- **NuGet Publish**: ${{ needs.publish-nuget.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ref**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "- Full package: RealmEngine-${{ github.ref_name }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- RealmForge: RealmForge-${{ github.ref_name }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- NuGet packages published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
        fi
