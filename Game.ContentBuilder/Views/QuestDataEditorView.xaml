<UserControl x:Class="Game.ContentBuilder.Views.QuestDataEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mdi="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:vm="clr-namespace:Game.ContentBuilder.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1400"
             d:DataContext="{d:DesignInstance Type=vm:QuestDataEditorViewModel}">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource MaterialDesignPaper}" 
                BorderBrush="{DynamicResource MaterialDesignDivider}" BorderThickness="0,0,0,1"
                Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="{Binding Title}" 
                               Style="{StaticResource MaterialDesignHeadline5TextBlock}"/>
                    <TextBlock Text="{Binding Description}" 
                               TextWrapping="Wrap"
                               Opacity="0.7"
                               Margin="0,4,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="16,0,0,0">
                    <Button Command="{Binding SaveCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            ToolTip="Save Changes (Ctrl+S)"
                            Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <mdi:PackIcon Kind="ContentSave" Margin="0,0,8,0"/>
                            <TextBlock Text="Save"/>
                        </StackPanel>
                    </Button>
                    
                    <Border Background="{DynamicResource MaterialDesignChipBackground}"
                            CornerRadius="12" Padding="12,6"
                            Visibility="{Binding IsDirty, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="Unsaved Changes" 
                                   Foreground="{DynamicResource PrimaryHueMidBrush}"
                                   FontWeight="Medium"/>
                    </Border>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="4"/>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="4"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Category Tree -->
            <Border Grid.Column="0" BorderBrush="{DynamicResource MaterialDesignDivider}" 
                    BorderThickness="0,0,1,0">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Categories" 
                               Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                               Margin="16,12,16,8"/>
                    
                    <TreeView ItemsSource="{Binding CategoryGroups}"
                              SelectedItemChanged="CategoryTree_SelectedItemChanged">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem" BasedOn="{StaticResource MaterialDesignTreeViewItem}">
                                <Setter Property="IsExpanded" Value="True"/>
                            </Style>
                        </TreeView.ItemContainerStyle>
                        
                        <!-- Category Groups -->
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Categories}">
                                <StackPanel Orientation="Horizontal">
                                    <mdi:PackIcon Kind="FolderOpen" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                </StackPanel>
                                
                                <!-- Categories -->
                                <HierarchicalDataTemplate.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <mdi:PackIcon Kind="Tag" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.7"/>
                                            <TextBlock Text="{Binding Name}"/>
                                            <TextBlock Text="{Binding ItemCount, StringFormat=' ({0})'}" 
                                                       Opacity="0.5" Margin="4,0,0,0"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </HierarchicalDataTemplate.ItemTemplate>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Background="{DynamicResource MaterialDesignDivider}"/>

            <!-- Items List -->
            <Border Grid.Column="2" BorderBrush="{DynamicResource MaterialDesignDivider}" 
                    BorderThickness="0,0,1,0">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="16,12,16,8">
                        <TextBlock Text="Items" Style="{StaticResource MaterialDesignSubtitle1TextBlock}"/>
                        <Button Command="{Binding NewItemCommand}" 
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                HorizontalAlignment="Stretch" Margin="0,8,0,0">
                            <StackPanel Orientation="Horizontal">
                                <mdi:PackIcon Kind="Plus" Margin="0,0,8,0"/>
                                <TextBlock Text="New Item"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Items}"
                             SelectedItem="{Binding SelectedItem}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="8" Margin="4,2">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Text="{Binding DisplayName}" 
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Grid.Row="1" Text="{Binding Name}" 
                                                   Opacity="0.6" FontSize="11"/>
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,4,0,0">
                                            <Border Background="{DynamicResource MaterialDesignChipBackground}"
                                                    CornerRadius="8" Padding="6,2" Margin="0,0,4,0">
                                                <TextBlock FontSize="10">
                                                    <Run Text="Weight:"/>
                                                    <Run Text="{Binding RarityWeight}" FontWeight="SemiBold"/>
                                                </TextBlock>
                                            </Border>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <GridSplitter Grid.Column="3" HorizontalAlignment="Stretch" Background="{DynamicResource MaterialDesignDivider}"/>

            <!-- Editor Panel -->
            <ScrollViewer Grid.Column="4" VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="16" IsEnabled="{Binding IsEditing}">
                    <TextBlock Text="Item Editor" 
                               Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                               Margin="0,0,0,16"/>

                    <!-- Name -->
                    <TextBox mdi:HintAssist.Hint="Name (identifier)"
                             Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,12"/>

                    <!-- Display Name -->
                    <TextBox mdi:HintAssist.Hint="Display Name"
                             Text="{Binding EditDisplayName, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,12"/>

                    <!-- Description -->
                    <TextBox mdi:HintAssist.Hint="Description"
                             Text="{Binding EditDescription, UpdateSourceTrigger=PropertyChanged}"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             MinLines="3"
                             MaxLines="6"
                             Margin="0,0,0,12"/>

                    <!-- Rarity Weight -->
                    <mdi:NumericUpDown mdi:HintAssist.Hint="Rarity Weight"
                                       Value="{Binding EditRarityWeight}"
                                       Minimum="1" Maximum="10000"
                                       Margin="0,0,0,12"/>

                    <!-- Optional Fields -->
                    <TextBlock Text="Optional Fields" 
                               Style="{StaticResource MaterialDesignBody2TextBlock}"
                               Opacity="0.7" Margin="0,8,0,8"/>

                    <!-- Modifier Formula (for rewards) -->
                    <TextBox mdi:HintAssist.Hint="Modifier Formula (optional)"
                             Text="{Binding EditModifierFormula, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,12"/>

                    <!-- Min/Max Values -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <mdi:NumericUpDown Grid.Column="0" 
                                           mdi:HintAssist.Hint="Min Value (optional)"
                                           Value="{Binding EditMinValue}"
                                           Minimum="0"/>

                        <mdi:NumericUpDown Grid.Column="2"
                                           mdi:HintAssist.Hint="Max Value (optional)"
                                           Value="{Binding EditMaxValue}"
                                           Minimum="0"/>
                    </Grid>

                    <!-- Item Type (for objectives) -->
                    <TextBox mdi:HintAssist.Hint="Item Type (optional)"
                             Text="{Binding EditItemType, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,12"/>

                    <!-- Actions -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                        <Button Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding SelectedItem}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Foreground="{DynamicResource ValidationErrorBrush}"
                                Margin="0,0,8,0"
                                Visibility="{Binding SelectedItem, Converter={StaticResource NullableToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal">
                                <mdi:PackIcon Kind="Delete" Margin="0,0,8,0"/>
                                <TextBlock Text="Delete"/>
                            </StackPanel>
                        </Button>

                        <Button Command="{Binding CancelEditCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Margin="0,0,8,0">
                            <TextBlock Text="Cancel"/>
                        </Button>

                        <Button Command="{Binding SaveItemCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}">
                            <StackPanel Orientation="Horizontal">
                                <mdi:PackIcon Kind="Check" Margin="0,0,8,0"/>
                                <TextBlock Text="Save Item"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource MaterialDesignPaper}"
                BorderBrush="{DynamicResource MaterialDesignDivider}" BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <mdi:PackIcon Kind="InformationOutline" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1" Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
