<UserControl x:Class="Game.ContentBuilder.Views.Components.PatternItemControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:converters="clr-namespace:Game.ContentBuilder.Converters">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:TupleConverter x:Key="TupleConverter"/>
    </UserControl.Resources>

    <materialDesign:Card Margin="0,0,0,8" 
                         Padding="12"
                         AutomationProperties.AutomationId="PatternCard">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Pattern Template with Weight -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="70"/>
                </Grid.ColumnDefinitions>

                <!-- Badge-based pattern composer -->
                <Border Grid.Column="0"
                        BorderBrush="{DynamicResource MaterialDesignDivider}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                        Padding="8"
                        Margin="0,0,8,0"
                        MinHeight="48"
                        ToolTip="Pattern badges - Click component buttons below to add tokens. Drag badges to reorder. {base} is required."
                        AutomationProperties.AutomationId="TemplateTextBox">
                    <ItemsControl x:Name="TokensItemsControl"
                                  AllowDrop="True">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Token Badge -->
                                <Border x:Name="TokenBadge"
                                        CornerRadius="12"
                                        Padding="10,4"
                                        Margin="0,0,6,4"
                                        Cursor="Hand"
                                        AllowDrop="True"
                                        Tag="{Binding}"
                                        AutomationProperties.AutomationId="TokenBadge">
                                    <Grid>
                                        <TextBlock x:Name="TokenText"
                                                   FontFamily="Consolas"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,20,0"/>
                                        <Button x:Name="DeleteTokenButton"
                                                Style="{StaticResource MaterialDesignIconButton}"
                                                Width="20"
                                                Height="20"
                                                Padding="0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center"
                                                Foreground="White"
                                                Background="#40000000"
                                                ToolTip="Remove token">
                                            <materialDesign:PackIcon Kind="Close"
                                                                     Width="14"
                                                                     Height="14"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>

                <StackPanel Grid.Column="1">
                    <TextBox x:Name="WeightTextBox"
                             HorizontalContentAlignment="Center"
                             materialDesign:HintAssist.Hint="Weight"
                             Margin="0,0,0,4">
                        <TextBox.Style>
                            <Style TargetType="TextBox" BasedOn="{StaticResource MaterialDesignTextBox}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=WeightTextBox, Path=IsReadOnly}" Value="True">
                                        <Setter Property="Background" Value="#F5F5F5"/>
                                        <Setter Property="Foreground" Value="#666"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    <ProgressBar x:Name="WeightProgressBar"
                                 Maximum="100"
                                 Height="4"
                                 Foreground="#4CAF50"/>
                </StackPanel>
            </Grid>

            <!-- Pattern Token Helpers -->
            <Border Grid.Row="1"
                    x:Name="TokenHelpersBorder"
                    Background="#F0F0F0"
                    CornerRadius="4"
                    Padding="8,6"
                    Margin="0,8,0,0">
                <StackPanel>
                    <!-- Component Tokens Section -->
                    <TextBlock Text="Insert Component:"
                               FontSize="10"
                               FontWeight="SemiBold"
                               Foreground="Gray"
                               Margin="0,0,0,4"/>
                    <ItemsControl x:Name="ComponentTokensItemsControl"
                                  Margin="0,0,0,8">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Content="{Binding StringFormat='{}{0}'}"
                                        x:Name="ComponentTokenButton"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        materialDesign:ButtonAssist.CornerRadius="4"
                                        Background="#4CAF50"
                                        Height="26"
                                        Padding="10,0"
                                        FontSize="11"
                                        FontFamily="Consolas"
                                        Margin="0,0,4,4"
                                        ToolTip="{Binding StringFormat='Insert {{0}} token'}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Reference Tokens Section -->
                    <TextBlock Text="Insert Reference:"
                               FontSize="10"
                               FontWeight="SemiBold"
                               Foreground="Gray"
                               Margin="0,0,0,4"/>
                    <ItemsControl>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <!-- Quick Insert: Common References -->
                        <Button x:Name="MaterialRefButton"
                                Content="@materialRef"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Height="24"
                                Padding="8,0"
                                FontSize="10"
                                FontFamily="Consolas"
                                Margin="0,0,4,4"
                                ToolTip="All materials (metals, leathers, woods, gemstones)"
                                AutomationProperties.AutomationId="ReferenceInsertButton"/>
                        <Button x:Name="WeaponRefButton"
                                Content="@weaponRef"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Height="24"
                                Padding="8,0"
                                FontSize="10"
                                FontFamily="Consolas"
                                Margin="0,0,4,4"
                                ToolTip="All weapons"/>
                        <Button x:Name="EnemyRefButton"
                                Content="@enemyRef"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Height="24"
                                Padding="8,0"
                                FontSize="10"
                                FontFamily="Consolas"
                                Margin="0,0,4,4"
                                ToolTip="All enemies"/>
                        <Button x:Name="BrowseButton"
                                Style="{StaticResource MaterialDesignFlatButton}"
                                Height="24"
                                Padding="8,0"
                                FontSize="10"
                                Margin="0,0,4,4"
                                AutomationProperties.AutomationId="BrowseReferencesButton">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FolderOpen"
                                                             Width="14"
                                                             Height="14"
                                                             Margin="0,0,4,0"/>
                                    <TextBlock Text="Browse..."/>
                                </StackPanel>
                            </Button.Content>
                        </Button>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Pattern Description -->
            <TextBlock Grid.Row="2"
                       x:Name="DescriptionTextBlock"
                       Style="{StaticResource MaterialDesignBody2TextBlock}"
                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                       TextWrapping="Wrap"
                       Margin="0,6,0,0"
                       FontSize="11"
                       AutomationProperties.AutomationId="PatternDescriptionTextBox"/>

            <!-- Example Generated Names -->
            <Border Grid.Row="3"
                    Background="#F5F5F5"
                    CornerRadius="4"
                    Padding="8,6"
                    Margin="0,8,0,0"
                    AutomationProperties.AutomationId="ExamplesPanel">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Examples:"
                                   FontSize="10"
                                   FontWeight="SemiBold"
                                   Foreground="Gray"
                                   Margin="0,0,0,4"/>
                        <TextBlock x:Name="ExamplesTextBlock"
                                   FontSize="11"
                                   FontFamily="Consolas"
                                   Foreground="#555"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                VerticalAlignment="Top"
                                Margin="8,0,0,0">
                        <Button x:Name="RegenerateButton"
                                Style="{StaticResource MaterialDesignIconButton}"
                                Width="24"
                                Height="24"
                                Padding="0"
                                ToolTip="Regenerate examples">
                            <materialDesign:PackIcon Kind="Refresh"
                                                     Width="16"
                                                     Height="16"/>
                        </Button>
                        <Button x:Name="DuplicateButton"
                                Style="{StaticResource MaterialDesignIconButton}"
                                Width="24"
                                Height="24"
                                Padding="0"
                                ToolTip="Duplicate this pattern">
                            <materialDesign:PackIcon Kind="ContentCopy"
                                                     Width="16"
                                                     Height="16"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </materialDesign:Card>
</UserControl>
