using System.Linq;
using System.Threading;
using FlaUI.Core;
using FlaUI.Core.AutomationElements;
using FlaUI.Core.Definitions;
using FlaUI.Core.Input;
using FlaUI.Core.WindowsAPI;
using FlaUI.UIA3;
using FluentAssertions;
using Xunit;
using Xunit.Abstractions;

namespace RealmForge.Tests.UI;

/// <summary>
/// Comprehensive UI tests for the Name List Editor (names.json v4 format)
/// Covers: Pattern management, component editing, reference tokens, name generation, CRUD operations
/// </summary>
[Collection("UI Tests")]
public class NameListEditor_ComprehensiveTests
{
    private readonly UITestCollectionFixture _fixture;
    private readonly ITestOutputHelper _output;
    private Application _app => _fixture.App!;
    private UIA3Automation _automation => _fixture.Automation!;
    private Window _mainWindow => _fixture.MainWindow!;

    public NameListEditor_ComprehensiveTests(UITestCollectionFixture fixture, ITestOutputHelper output)
    {
        _fixture = fixture;
        _output = output;
        Thread.Sleep(500);
        NavigateToEnemiesNamesEditor(); // Navigate to enemies/beasts/names.json
    }

    #region Pattern Management Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Patterns")]
    public void Should_Display_Pattern_List()
    {
        // Act - Look for pattern cards/list
        var patternCards = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternCard"));
        
        _output.WriteLine($"Found {patternCards.Length} pattern cards");

        // Assert
        patternCards.Should().NotBeEmpty("Should display at least one pattern");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Patterns")]
    public void Should_Add_New_Pattern_When_Add_Button_Clicked()
    {
        // Arrange
        var initialPatternCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternCard")).Length;
        _output.WriteLine($"Initial pattern count: {initialPatternCount}");

        // Act - PatternAddButton is the correct AutomationId
        var addButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternAddButton"));
        _output.WriteLine($"PatternAddButton found: {addButton != null}");
        
        addButton?.AsButton()?.Click();
        Thread.Sleep(500);

        // Assert
        var newPatternCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternCard")).Length;
        _output.WriteLine($"New pattern count: {newPatternCount}");
        newPatternCount.Should().Be(initialPatternCount + 1, "Should add one new pattern");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Patterns")]
    public void Should_Delete_Pattern_When_Delete_Button_Clicked()
    {
        // Arrange - Ensure we have at least 2 patterns
        var addButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("AddPatternButton"));
        addButton?.Click();
        Thread.Sleep(500);

        var initialCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternCard")).Length;

        // Act - Click delete on first pattern
        var deleteButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("DeletePatternButton"));
        deleteButton?.Click();
        Thread.Sleep(500);

        // Assert
        var newCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternCard")).Length;
        newCount.Should().Be(initialCount - 1, "Should remove one pattern");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Patterns")]
    public void Should_Display_Pattern_Template_Field()
    {
        // Act
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"));

        // Assert
        templateTextBox.Should().NotBeNull("Pattern template textbox should exist");
        templateTextBox.IsEnabled.Should().BeTrue("Template field should be editable");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Patterns")]
    public void Should_Update_Template_When_Text_Changed()
    {
        // Arrange
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();

        // Act
        templateTextBox?.Enter("{size} {base}");
        Thread.Sleep(500);

        // Assert
        templateTextBox?.Text.Should().Contain("size", "Template should contain entered text");
        templateTextBox?.Text.Should().Contain("base", "Template should contain entered text");
    }

    #endregion

    #region Component Token Management Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Components")]
    public void Should_Display_Available_Component_Tokens()
    {
        // Act - Look for component insertion area
        var componentButtons = _mainWindow.FindAllDescendants(cf => 
            cf.ByName("size") // Common component name
            .And(cf.ByControlType(ControlType.Button)));

        // Assert
        componentButtons.Should().NotBeEmpty("Should display component insertion buttons");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Components")]
    public void Should_Insert_Component_Token_When_Button_Clicked()
    {
        // Arrange
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        
        // Clear existing template
        templateTextBox?.Enter("");
        
        // Act - Click a component button (e.g., "size")
        var sizeButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByName("size")
            .And(cf.ByControlType(ControlType.Button)));
        sizeButton?.Click();
        Thread.Sleep(500);

        // Assert
        templateTextBox?.Text.Should().Contain("{size}", "Template should contain inserted component token");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Components")]
    public void Should_Display_Token_Badges_For_Pattern_Components()
    {
        // Arrange - Set a template with tokens
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size} {base}");
        Thread.Sleep(500);

        // Act - Look for badge display
        var badges = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("TokenBadge"));

        // Assert
        badges.Should().NotBeEmpty("Should display token badges for components in pattern");
    }

    #endregion

    #region Reference Token Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "References")]
    public void Should_Display_Reference_Insertion_Buttons()
    {
        // Act
        var materialRefButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByName("@materialRef"));
        var weaponRefButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByName("@weaponRef"));
        var enemyRefButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByName("@enemyRef"));

        // Assert
        (materialRefButton != null || weaponRefButton != null || enemyRefButton != null)
            .Should().BeTrue("Should display at least one reference insertion button");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "References")]
    public void Should_Open_Browse_Dialog_When_Browse_Button_Clicked()
    {
        // Act
        var browseButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByName("Browse...")
            .And(cf.ByControlType(ControlType.Button)));
        browseButton?.Click();
        Thread.Sleep(1000);

        // Assert
        var dialog = _app.GetAllTopLevelWindows(_automation)
            .FirstOrDefault(w => w.Title.Contains("Reference Selector"));
        dialog.Should().NotBeNull("Browse References dialog should open");
        
        // Cleanup
        dialog?.Close();
    }

    #endregion

    #region Example Generation Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Examples")]
    public void Should_Display_Generated_Examples()
    {
        // Act
        var examplesSection = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("ExamplesPanel"));

        // Assert
        examplesSection.Should().NotBeNull("Should display examples section");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Examples")]
    public void Should_Update_Examples_When_Pattern_Changes()
    {
        // Arrange
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        var examplesPanel = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("ExamplesPanel"));

        // Act - Change template
        templateTextBox?.Enter("{size} {base}");
        Thread.Sleep(1000); // Wait for example generation

        // Assert - Examples should be visible and contain text
        examplesPanel.Should().NotBeNull();
        var exampleText = examplesPanel?.FindAllDescendants();
        exampleText?.Should().NotBeEmpty("Should display generated examples");
    }

    #endregion

    #region Component Editor Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "ComponentEditor")]
    public void Should_Open_Component_Editor_When_Badge_Clicked()
    {
        // Arrange - Ensure we have a token in template
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size}");
        Thread.Sleep(500);

        // Act - Click on a token badge
        var badge = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("TokenBadge"));
        badge?.Click();
        Thread.Sleep(500);

        // Assert - Component editor should be visible
        var componentEditor = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("ComponentEditorPanel"));
        componentEditor.Should().NotBeNull("Component editor should open when badge clicked");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "ComponentEditor")]
    public void Should_Display_Value_List_In_Component_Editor()
    {
        // Arrange - Open component editor
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size}");
        Thread.Sleep(500);

        var badge = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("TokenBadge"));
        badge?.Click();
        Thread.Sleep(500);

        // Act - Look for value list
        var valueList = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("ComponentValuesList"));

        // Assert
        valueList.Should().NotBeNull("Component editor should display value list");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "ComponentEditor")]
    public void Should_Add_New_Value_When_Add_Button_Clicked()
    {
        // Arrange - Open component editor
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size}");
        Thread.Sleep(500);

        var badge = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("TokenBadge"));
        badge?.Click();
        Thread.Sleep(500);

        var initialValueCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("ComponentValue")).Length;

        // Act - Click add value button
        var addValueButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("AddValueButton"));
        addValueButton?.Click();
        Thread.Sleep(500);

        // Assert
        var newValueCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("ComponentValue")).Length;
        newValueCount.Should().Be(initialValueCount + 1, "Should add one new value");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "ComponentEditor")]
    public void Should_Delete_Value_When_Delete_Button_Clicked()
    {
        // Arrange - Open component editor and ensure values exist
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size}");
        Thread.Sleep(500);

        var badge = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("TokenBadge"));
        badge?.Click();
        Thread.Sleep(500);

        var initialValueCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("ComponentValue")).Length;

        // Act - Click delete on first value
        var deleteButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("DeleteValueButton"));
        deleteButton?.Click();
        Thread.Sleep(500);

        // Assert
        var newValueCount = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("ComponentValue")).Length;
        newValueCount.Should().BeLessThan(initialValueCount, "Should remove a value");
    }

    #endregion

    #region Pattern Description Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Description")]
    public void Should_Display_Description_Field()
    {
        // Act
        var descriptionTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternDescriptionTextBox"));

        // Assert
        descriptionTextBox.Should().NotBeNull("Should display pattern description field");
    }

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Description")]
    public void Should_Update_Description_When_Text_Changed()
    {
        // Arrange
        var descriptionTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternDescriptionTextBox"))?.AsTextBox();

        // Act
        descriptionTextBox?.Enter("Test description for this pattern");
        Thread.Sleep(500);

        // Assert
        descriptionTextBox?.Text.Should().Contain("Test description", "Description should update");
    }

    #endregion

    #region Save/Load Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Persistence")]
    public void Should_Display_Save_Status_Message()
    {
        // Arrange - Make a change
        var templateTextBox = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("PatternTemplateTextBox"))?.AsTextBox();
        templateTextBox?.Enter("{size} {base}");
        Thread.Sleep(500);

        // Act - Trigger save (Ctrl+S)
        Keyboard.Type(VirtualKeyShort.CONTROL, VirtualKeyShort.KEY_S);
        Thread.Sleep(1000);

        // Assert - Look for save confirmation in status bar
        var statusBar = _mainWindow.FindFirstDescendant(cf => 
            cf.ByControlType(ControlType.StatusBar));
        
        // Status message should appear somewhere
        statusBar.Should().NotBeNull("Should have status bar showing save status");
    }

    #endregion

    #region Integration Tests

    [Fact]
    [Trait("Category", "UI")]
    [Trait("Editor", "NameList")]
    [Trait("Feature", "Integration")]
    public void Should_Complete_Full_Pattern_Creation_Workflow()
    {
        // Arrange
        var addPatternButton = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("AddPatternButton"));

        // Act 1: Add new pattern
        addPatternButton?.Click();
        Thread.Sleep(500);

        // Act 2: Set template
        var templateTextBox = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternTemplateTextBox")).LastOrDefault()?.AsTextBox();
        templateTextBox?.Enter("{size} {type} {base}");
        Thread.Sleep(500);

        // Act 3: Set description
        var descriptionTextBox = _mainWindow.FindAllDescendants(cf => 
            cf.ByAutomationId("PatternDescriptionTextBox")).LastOrDefault()?.AsTextBox();
        descriptionTextBox?.Enter("Test pattern description");
        Thread.Sleep(500);

        // Assert: All changes should be reflected
        templateTextBox?.Text.Should().Contain("size");
        descriptionTextBox?.Text.Should().Contain("Test pattern");
        
        // Examples should be generated
        var examplesPanel = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("ExamplesPanel"));
        examplesPanel.Should().NotBeNull("Examples should be generated");
    }

    #endregion

    private void NavigateToEnemiesNamesEditor()
    {
        // Navigate to enemies/beasts/names.json
        var treeView = _mainWindow.FindFirstDescendant(cf => 
            cf.ByAutomationId("CategoryTreeView"));

        if (treeView != null)
        {
            // Expand enemies
            var enemiesItem = treeView.FindFirstDescendant(cf => 
                cf.ByName("enemies"));
            enemiesItem?.AsTreeItem()?.Expand();
            Thread.Sleep(500);

            // Expand beasts
            var beastsItem = treeView.FindFirstDescendant(cf => 
                cf.ByName("beasts"));
            beastsItem?.AsTreeItem()?.Expand();
            Thread.Sleep(500);

            // Select names.json to trigger editor loading
            var namesItem = treeView.FindFirstDescendant(cf => 
                cf.ByName("names.json"));
            namesItem?.AsTreeItem()?.Select();
            Thread.Sleep(3000);
        }
    }
}
